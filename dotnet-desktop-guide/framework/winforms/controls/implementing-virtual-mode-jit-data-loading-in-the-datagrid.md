---
title: DataGridView コントロールでの Just-in-time データ読み込みによる仮想モードの実装
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- examples [Windows Forms], just-in-time data loading
- data [Windows Forms], managing large data sets
- DataGridView control [Windows Forms], virtual mode
- just-in-time data loading
- DataGridView control [Windows Forms], large data sets
- virtual mode [Windows Forms], just-in-time data loading
ms.assetid: c2a052b9-423c-4ff7-91dc-d8c7c79345f6
ms.openlocfilehash: 5f1d3faad0bb05305086bc46076137f5b1202cb6
ms.sourcegitcommit: 9f6df084c53a3da0ea657ed0d708a72213683084
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/09/2020
ms.locfileid: "96980659"
---
# <a name="implementing-virtual-mode-with-just-in-time-data-loading-in-the-windows-forms-datagridview-control"></a><span data-ttu-id="b7a53-102">Windows フォーム DataGridView コントロールでの Just-In-Time データ読み込みによる仮想モードの実装</span><span class="sxs-lookup"><span data-stu-id="b7a53-102">Implementing Virtual Mode with Just-In-Time Data Loading in the Windows Forms DataGridView Control</span></span>

<span data-ttu-id="b7a53-103">コントロールに仮想モードを実装する理由 <xref:System.Windows.Forms.DataGridView> の1つは、必要なときにのみデータを取得することです。</span><span class="sxs-lookup"><span data-stu-id="b7a53-103">One reason to implement virtual mode in the <xref:System.Windows.Forms.DataGridView> control is to retrieve data only as it is needed.</span></span> <span data-ttu-id="b7a53-104">これは *just-in-time データ読み込み* と呼ばれます。</span><span class="sxs-lookup"><span data-stu-id="b7a53-104">This is called *just-in-time data loading*.</span></span>  
  
 <span data-ttu-id="b7a53-105">たとえば、リモートデータベースで非常に大きなテーブルを使用している場合は、ユーザーが新しい行をビューにスクロールしたときにのみ、表示および追加データを取得するために必要なデータのみを取得することで、起動の遅延を回避できます。</span><span class="sxs-lookup"><span data-stu-id="b7a53-105">If you are working with a very large table in a remote database, for example, you might want to avoid startup delays by retrieving only the data that is necessary for display and retrieving additional data only when the user scrolls new rows into view.</span></span> <span data-ttu-id="b7a53-106">アプリケーションを実行しているクライアントコンピューターで、データの格納に使用できるメモリの量が限られている場合は、データベースから新しい値を取得するときに、未使用のデータを破棄することもできます。</span><span class="sxs-lookup"><span data-stu-id="b7a53-106">If the client computers running your application have a limited amount of memory available for storing data, you might also want to discard unused data when retrieving new values from the database.</span></span>  
  
 <span data-ttu-id="b7a53-107">次のセクションでは、just-in-time キャッシュでコントロールを使用する方法について説明し <xref:System.Windows.Forms.DataGridView> ます。</span><span class="sxs-lookup"><span data-stu-id="b7a53-107">The following sections describe how to use a <xref:System.Windows.Forms.DataGridView> control with a just-in-time cache.</span></span>  
  
 <span data-ttu-id="b7a53-108">このトピックのコードを単一のリストとしてコピーする方法については、「 [方法: Windows フォーム DataGridView コントロールで Just-in-time データ読み込みを使用して仮想モードを実装](virtual-mode-with-just-in-time-data-loading-in-the-datagrid.md)する」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="b7a53-108">To copy the code in this topic as a single listing, see [How to: Implement Virtual Mode with Just-In-Time Data Loading in the Windows Forms DataGridView Control](virtual-mode-with-just-in-time-data-loading-in-the-datagrid.md).</span></span>  
  
## <a name="the-form"></a><span data-ttu-id="b7a53-109">フォーム</span><span class="sxs-lookup"><span data-stu-id="b7a53-109">The Form</span></span>  

 <span data-ttu-id="b7a53-110">次のコード例では、 <xref:System.Windows.Forms.DataGridView> イベントハンドラーを通じてオブジェクトと対話する読み取り専用のコントロールを含むフォームを定義し `Cache` <xref:System.Windows.Forms.DataGridView.CellValueNeeded> ます。</span><span class="sxs-lookup"><span data-stu-id="b7a53-110">The following code example defines a form containing a read-only <xref:System.Windows.Forms.DataGridView> control that interacts with a `Cache` object through a <xref:System.Windows.Forms.DataGridView.CellValueNeeded> event handler.</span></span> <span data-ttu-id="b7a53-111">オブジェクトは、 `Cache` ローカルに格納されている値を管理し、オブジェクトを使用して `DataRetriever` サンプル Northwind データベースの Orders テーブルから値を取得します。</span><span class="sxs-lookup"><span data-stu-id="b7a53-111">The `Cache` object manages the locally stored values and uses a `DataRetriever` object to retrieve values from the Orders table of the sample Northwind database.</span></span> <span data-ttu-id="b7a53-112">`DataRetriever`クラスに必要なインターフェイスを実装するオブジェクトは、 `IDataPageRetriever` コントロールの `Cache` 行と列を初期化するためにも使用され <xref:System.Windows.Forms.DataGridView> ます。</span><span class="sxs-lookup"><span data-stu-id="b7a53-112">The `DataRetriever` object, which implements the `IDataPageRetriever` interface required by the `Cache` class, is also used to initialize the <xref:System.Windows.Forms.DataGridView> control rows and columns.</span></span>  
  
 <span data-ttu-id="b7a53-113">`IDataPageRetriever`、 `DataRetriever` 、およびの各型について `Cache` は、このトピックの後半で説明します。</span><span class="sxs-lookup"><span data-stu-id="b7a53-113">The `IDataPageRetriever`, `DataRetriever`, and `Cache` types are described later in this topic.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="b7a53-114">接続文字列内に機密情報 (パスワードなど) を格納すると、アプリケーションのセキュリティに影響を及ぼすことがあります。</span><span class="sxs-lookup"><span data-stu-id="b7a53-114">Storing sensitive information, such as a password, within the connection string can affect the security of your application.</span></span> <span data-ttu-id="b7a53-115">データベースへのアクセスを制御する方法としては、Windows 認証 (統合セキュリティとも呼ばれます) を使用する方が安全です。</span><span class="sxs-lookup"><span data-stu-id="b7a53-115">Using Windows Authentication (also known as integrated security) is a more secure way to control access to a database.</span></span> <span data-ttu-id="b7a53-116">詳細については、「[接続情報の保護](/dotnet/framework/data/adonet/protecting-connection-information)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="b7a53-116">For more information, see [Protecting Connection Information](/dotnet/framework/data/adonet/protecting-connection-information).</span></span>  
  
 [!code-csharp[System.Windows.Forms.DataGridView.Virtual_lazyloading#100](~/samples/snippets/csharp/VS_Snippets_Winforms/System.Windows.Forms.DataGridView.Virtual_lazyloading/CS/lazyloading.cs#100)]
 [!code-vb[System.Windows.Forms.DataGridView.Virtual_lazyloading#100](~/samples/snippets/visualbasic/VS_Snippets_Winforms/System.Windows.Forms.DataGridView.Virtual_lazyloading/VB/lazyloading.vb#100)]  
  
## <a name="the-idatapageretriever-interface"></a><span data-ttu-id="b7a53-117">IDataPageRetriever インターフェイス</span><span class="sxs-lookup"><span data-stu-id="b7a53-117">The IDataPageRetriever Interface</span></span>  

 <span data-ttu-id="b7a53-118">次のコード例では、 `IDataPageRetriever` クラスによって実装されるインターフェイスを定義し `DataRetriever` ます。</span><span class="sxs-lookup"><span data-stu-id="b7a53-118">The following code example defines the `IDataPageRetriever` interface, which is implemented by the `DataRetriever` class.</span></span> <span data-ttu-id="b7a53-119">このインターフェイスで宣言されているメソッドは、 `SupplyPageOfData` 最初の行インデックスと1つのデータページの行数のカウントを必要とするメソッドだけです。</span><span class="sxs-lookup"><span data-stu-id="b7a53-119">The only method declared in this interface is the `SupplyPageOfData` method, which requires an initial row index and a count of the number of rows in a single page of data.</span></span> <span data-ttu-id="b7a53-120">これらの値は、データソースからデータのサブセットを取得するために実装側によって使用されます。</span><span class="sxs-lookup"><span data-stu-id="b7a53-120">These values are used by the implementer to retrieve a subset of data from a data source.</span></span>  
  
 <span data-ttu-id="b7a53-121">オブジェクトは、 `Cache` 構築中にこのインターフェイスの実装を使用して、2つの初期ページのデータを読み込みます。</span><span class="sxs-lookup"><span data-stu-id="b7a53-121">A `Cache` object uses an implementation of this interface during construction to load two initial pages of data.</span></span> <span data-ttu-id="b7a53-122">キャッシュされていない値が必要な場合、キャッシュはこれらのページのいずれかを破棄し、からの値を含む新しいページを要求し `IDataPageRetriever` ます。</span><span class="sxs-lookup"><span data-stu-id="b7a53-122">Whenever an uncached value is needed, the cache discards one of these pages and requests a new page containing the value from the `IDataPageRetriever`.</span></span>  
  
 [!code-csharp[System.Windows.Forms.DataGridView.Virtual_lazyloading#201](~/samples/snippets/csharp/VS_Snippets_Winforms/System.Windows.Forms.DataGridView.Virtual_lazyloading/CS/lazyloading.cs#201)]
 [!code-vb[System.Windows.Forms.DataGridView.Virtual_lazyloading#201](~/samples/snippets/visualbasic/VS_Snippets_Winforms/System.Windows.Forms.DataGridView.Virtual_lazyloading/VB/lazyloading.vb#201)]  
  
## <a name="the-dataretriever-class"></a><span data-ttu-id="b7a53-123">DataRetriever コンポーネントクラス</span><span class="sxs-lookup"><span data-stu-id="b7a53-123">The DataRetriever Class</span></span>  

 <span data-ttu-id="b7a53-124">次のコード例では、 `DataRetriever` `IDataPageRetriever` サーバーからデータページを取得するためのインターフェイスを実装するクラスを定義しています。</span><span class="sxs-lookup"><span data-stu-id="b7a53-124">The following code example defines the `DataRetriever` class, which implements the `IDataPageRetriever` interface to retrieve pages of data from a server.</span></span> <span data-ttu-id="b7a53-125">クラスには、 `DataRetriever` プロパティとプロパティも用意されて `Columns` `RowCount` います。このプロパティは、コントロールがを使用して <xref:System.Windows.Forms.DataGridView> 必要な列を作成し、適切な数の空の行をコレクションに追加し <xref:System.Windows.Forms.DataGridView.Rows%2A> ます。</span><span class="sxs-lookup"><span data-stu-id="b7a53-125">The `DataRetriever` class also provides `Columns` and `RowCount` properties, which the <xref:System.Windows.Forms.DataGridView> control uses to create the necessary columns and to add the appropriate number of empty rows to the <xref:System.Windows.Forms.DataGridView.Rows%2A> collection.</span></span> <span data-ttu-id="b7a53-126">コントロールがテーブル内のすべてのデータを含んでいるかのように動作するように、空の行を追加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="b7a53-126">Adding the empty rows is necessary so that the control will behave as though it contains all the data in the table.</span></span> <span data-ttu-id="b7a53-127">これは、スクロールバーのスクロールボックスが適切なサイズになり、ユーザーがテーブル内の任意の行にアクセスできるようになることを意味します。</span><span class="sxs-lookup"><span data-stu-id="b7a53-127">This means that the scroll box in the scroll bar will have the appropriate size, and the user will be able to access any row in the table.</span></span> <span data-ttu-id="b7a53-128">行は、 <xref:System.Windows.Forms.DataGridView.CellValueNeeded> スクロールして表示される場合にのみ、イベントハンドラーによって入力されます。</span><span class="sxs-lookup"><span data-stu-id="b7a53-128">The rows are filled by the <xref:System.Windows.Forms.DataGridView.CellValueNeeded> event handler only when they are scrolled into view.</span></span>  
  
 [!code-csharp[System.Windows.Forms.DataGridView.Virtual_lazyloading#200](~/samples/snippets/csharp/VS_Snippets_Winforms/System.Windows.Forms.DataGridView.Virtual_lazyloading/CS/lazyloading.cs#200)]
 [!code-vb[System.Windows.Forms.DataGridView.Virtual_lazyloading#200](~/samples/snippets/visualbasic/VS_Snippets_Winforms/System.Windows.Forms.DataGridView.Virtual_lazyloading/VB/lazyloading.vb#200)]  
  
## <a name="the-cache-class"></a><span data-ttu-id="b7a53-129">Cache クラス</span><span class="sxs-lookup"><span data-stu-id="b7a53-129">The Cache Class</span></span>  

 <span data-ttu-id="b7a53-130">次のコード例では、 `Cache` 実装を通じて設定される2ページのデータを管理するクラスを定義し `IDataPageRetriever` ます。</span><span class="sxs-lookup"><span data-stu-id="b7a53-130">The following code example defines the `Cache` class, which manages two pages of data populated through an `IDataPageRetriever` implementation.</span></span> <span data-ttu-id="b7a53-131">クラスは、 `Cache` `DataPage` <xref:System.Data.DataTable> 1 つのキャッシュページに値を格納し、ページの上限と下限を表す行インデックスを計算するを含む内部構造体を定義します。</span><span class="sxs-lookup"><span data-stu-id="b7a53-131">The `Cache` class defines an inner `DataPage` structure, which contains a <xref:System.Data.DataTable> to store the values in a single cache page and which calculates the row indexes that represent the upper and lower boundaries of the page.</span></span>  
  
 <span data-ttu-id="b7a53-132">クラスは、 `Cache` 構築時に2ページのデータを読み込みます。</span><span class="sxs-lookup"><span data-stu-id="b7a53-132">The `Cache` class loads two pages of data at construction time.</span></span> <span data-ttu-id="b7a53-133">イベントが <xref:System.Windows.Forms.DataGridView.CellValueNeeded> 値を要求するたびに、オブジェクトは、その `Cache` 値が2つのページのいずれかで使用できるかどうかを判断し、存在する場合はそれを返します。</span><span class="sxs-lookup"><span data-stu-id="b7a53-133">Whenever the <xref:System.Windows.Forms.DataGridView.CellValueNeeded> event requests a value, the `Cache` object determines if the value is available in one of its two pages and, if so, returns it.</span></span> <span data-ttu-id="b7a53-134">値がローカルで使用できない場合、 `Cache` オブジェクトは、現在表示されている行から最も遠い2つのページを特定し、そのページを要求された値を含む新しいページに置き換えます。</span><span class="sxs-lookup"><span data-stu-id="b7a53-134">If the value is not available locally, the `Cache` object determines which of its two pages is farthest from the currently displayed rows and replaces the page with a new one containing the requested value, which it then returns.</span></span>  
  
 <span data-ttu-id="b7a53-135">データページ内の行の数が、一度に画面に表示できる行数と同じであると仮定すると、このモデルでは、ユーザーがテーブルをページングして、最も最近表示されたページに効率的に戻ることができます。</span><span class="sxs-lookup"><span data-stu-id="b7a53-135">Assuming that the number of rows in a data page is the same as the number of rows that can be displayed on screen at once, this model allows users paging through the table to efficiently return to the most recently viewed page.</span></span>  
  
 [!code-csharp[System.Windows.Forms.DataGridView.Virtual_lazyloading#300](~/samples/snippets/csharp/VS_Snippets_Winforms/System.Windows.Forms.DataGridView.Virtual_lazyloading/CS/lazyloading.cs#300)]
 [!code-vb[System.Windows.Forms.DataGridView.Virtual_lazyloading#300](~/samples/snippets/visualbasic/VS_Snippets_Winforms/System.Windows.Forms.DataGridView.Virtual_lazyloading/VB/lazyloading.vb#300)]  
  
## <a name="additional-considerations"></a><span data-ttu-id="b7a53-136">その他の考慮事項</span><span class="sxs-lookup"><span data-stu-id="b7a53-136">Additional Considerations</span></span>  

 <span data-ttu-id="b7a53-137">前のコード例は、just-in-time データ読み込みのデモとして提供されています。</span><span class="sxs-lookup"><span data-stu-id="b7a53-137">The previous code examples are provided as a demonstration of just-in-time data loading.</span></span> <span data-ttu-id="b7a53-138">最大限の効率を実現するには、独自のニーズに合わせてコードを変更する必要があります。</span><span class="sxs-lookup"><span data-stu-id="b7a53-138">You will need to modify the code for your own needs to achieve maximum efficiency.</span></span> <span data-ttu-id="b7a53-139">少なくとも、キャッシュ内のデータの1ページあたりの行数に適切な値を選択する必要があります。</span><span class="sxs-lookup"><span data-stu-id="b7a53-139">At minimum, you will need to choose an appropriate value for the number of rows per page of data in the cache.</span></span> <span data-ttu-id="b7a53-140">この値は、コンストラクターに渡され `Cache` ます。</span><span class="sxs-lookup"><span data-stu-id="b7a53-140">This value is passed into the `Cache` constructor.</span></span> <span data-ttu-id="b7a53-141">1ページあたりの行数は、コントロールに同時に表示できる行の数より少なくする必要があり <xref:System.Windows.Forms.DataGridView> ます。</span><span class="sxs-lookup"><span data-stu-id="b7a53-141">The number of rows per page should be no less than the number of rows that can be displayed simultaneously in your <xref:System.Windows.Forms.DataGridView> control.</span></span>  
  
 <span data-ttu-id="b7a53-142">最良の結果を得るには、パフォーマンステストとユーザビリティテストを実施して、システムとユーザーの要件を決定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="b7a53-142">For best results, you will need to conduct performance testing and usability testing to determine the requirements of your system and your users.</span></span> <span data-ttu-id="b7a53-143">考慮する必要がある要素には、アプリケーションを実行しているクライアントコンピューターのメモリの量、使用されるネットワーク接続の使用可能な帯域幅、および使用されるサーバーの待機時間などがあります。</span><span class="sxs-lookup"><span data-stu-id="b7a53-143">Several factors that you will need to take into consideration include the amount of memory in the client machines running your application, the available bandwidth of the network connection used, and the latency of the server used.</span></span> <span data-ttu-id="b7a53-144">帯域幅と待機時間は、ピーク時の使用時に決定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="b7a53-144">The bandwidth and latency should be determined at times of peak usage.</span></span>  
  
 <span data-ttu-id="b7a53-145">アプリケーションのスクロールパフォーマンスを向上させるために、ローカルに保存されるデータの量を増やすことができます。</span><span class="sxs-lookup"><span data-stu-id="b7a53-145">To improve the scrolling performance of your application, you can increase the amount of data stored locally.</span></span> <span data-ttu-id="b7a53-146">ただし、起動時間を短縮するには、最初に大量のデータが読み込まれないようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="b7a53-146">To improve startup time, however, you must avoid loading too much data initially.</span></span> <span data-ttu-id="b7a53-147">クラスを変更して、 `Cache` 格納できるデータページの数を増やすことができます。</span><span class="sxs-lookup"><span data-stu-id="b7a53-147">You may want to modify the `Cache` class to increase the number of data pages it can store.</span></span> <span data-ttu-id="b7a53-148">より多くのデータページを使用すると、スクロール効率が向上しますが、使用可能な帯域幅とサーバーの待機時間によっては、データページ内の最適な行数を確認する必要があります。</span><span class="sxs-lookup"><span data-stu-id="b7a53-148">Using more data pages can improve scrolling efficiency, but you will need to determine the ideal number of rows in a data page, depending on the available bandwidth and the server latency.</span></span> <span data-ttu-id="b7a53-149">ページ数を小さくすると、サーバーにはより頻繁にアクセスされますが、要求されたデータが返されるまでにかかる時間は短くなります。</span><span class="sxs-lookup"><span data-stu-id="b7a53-149">With smaller pages, the server will be accessed more frequently, but will take less time to return the requested data.</span></span> <span data-ttu-id="b7a53-150">待機時間が帯域幅よりも大きな問題である場合は、より大きなデータページを使用することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="b7a53-150">If latency is more of an issue than bandwidth, you may want to use larger data pages.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="b7a53-151">関連項目</span><span class="sxs-lookup"><span data-stu-id="b7a53-151">See also</span></span>

- <xref:System.Windows.Forms.DataGridView>
- <xref:System.Windows.Forms.DataGridView.VirtualMode%2A>
- [<span data-ttu-id="b7a53-152">Windows フォーム DataGridView コントロールでのパフォーマンス チューニング</span><span class="sxs-lookup"><span data-stu-id="b7a53-152">Performance Tuning in the Windows Forms DataGridView Control</span></span>](performance-tuning-in-the-windows-forms-datagridview-control.md)
- [<span data-ttu-id="b7a53-153">Windows フォーム DataGridView コントロールを拡張するための推奨される手順</span><span class="sxs-lookup"><span data-stu-id="b7a53-153">Best Practices for Scaling the Windows Forms DataGridView Control</span></span>](best-practices-for-scaling-the-windows-forms-datagridview-control.md)
- [<span data-ttu-id="b7a53-154">Windows フォーム DataGridView コントロールでの仮想モード</span><span class="sxs-lookup"><span data-stu-id="b7a53-154">Virtual Mode in the Windows Forms DataGridView Control</span></span>](virtual-mode-in-the-windows-forms-datagridview-control.md)
- [<span data-ttu-id="b7a53-155">チュートリアル: Windows フォーム DataGridView コントロールでの仮想モードを実装する</span><span class="sxs-lookup"><span data-stu-id="b7a53-155">Walkthrough: Implementing Virtual Mode in the Windows Forms DataGridView Control</span></span>](implementing-virtual-mode-wf-datagridview-control.md)
- [<span data-ttu-id="b7a53-156">方法: Windows フォーム DataGridView コントロールで Just-In-Time データ読み込みを使用して仮想モードを実装する</span><span class="sxs-lookup"><span data-stu-id="b7a53-156">How to: Implement Virtual Mode with Just-In-Time Data Loading in the Windows Forms DataGridView Control</span></span>](virtual-mode-with-just-in-time-data-loading-in-the-datagrid.md)
