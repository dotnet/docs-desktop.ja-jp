---
title: Direct3D9 および WPF の相互運用性のパフォーマンスに関する考慮事項
titleSuffix: ''
ms.date: 03/30/2017
helpviewer_keywords:
- WPF [WPF], Direct3D9 interop performance
- Direct3D9 [WPF interoperability], performance
ms.assetid: ea8baf91-12fe-4b44-ac4d-477110ab14dd
ms.openlocfilehash: 2445732c27d210a41da26303d6a9ce07ef6fcc94
ms.sourcegitcommit: 9f6df084c53a3da0ea657ed0d708a72213683084
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/09/2020
ms.locfileid: "96981944"
---
# <a name="performance-considerations-for-direct3d9-and-wpf-interoperability"></a><span data-ttu-id="dce59-102">Direct3D9 および WPF の相互運用性のパフォーマンスに関する考慮事項</span><span class="sxs-lookup"><span data-stu-id="dce59-102">Performance Considerations for Direct3D9 and WPF Interoperability</span></span>
<span data-ttu-id="dce59-103"><xref:System.Windows.Interop.D3DImage> クラスを使用して、Direct3D9 コンテンツをホストできます。</span><span class="sxs-lookup"><span data-stu-id="dce59-103">You can host Direct3D9 content by using the <xref:System.Windows.Interop.D3DImage> class.</span></span> <span data-ttu-id="dce59-104">Direct3D9 コンテンツをホストすると、アプリケーションのパフォーマンスに影響する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="dce59-104">Hosting Direct3D9 content can affect the performance of your application.</span></span> <span data-ttu-id="dce59-105">このトピックでは、Windows Presentation Foundation (WPF) アプリケーションで Direct3D9 コンテンツをホストするときのパフォーマンスを最適化するためのベスト プラクティスについて説明します。</span><span class="sxs-lookup"><span data-stu-id="dce59-105">This topic describes best practices to optimize performance when hosting Direct3D9 content in a Windows Presentation Foundation (WPF) application.</span></span> <span data-ttu-id="dce59-106">これらのベスト プラクティスには、Windows Vista、Windows XP、およびマルチモニター ディスプレイを使用している場合の <xref:System.Windows.Interop.D3DImage> の使用方法とベスト プラクティスが含まれています。</span><span class="sxs-lookup"><span data-stu-id="dce59-106">These best practices include how to use <xref:System.Windows.Interop.D3DImage> and best practices when you are using Windows Vista, Windows XP, and multi-monitor displays.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="dce59-107">これらのベスト プラクティスを示すコード例については、「[WPF と Direct3D9 の相互運用性](wpf-and-direct3d9-interoperation.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="dce59-107">For code examples that demonstrate these best practices, see [WPF and Direct3D9 Interoperation](wpf-and-direct3d9-interoperation.md).</span></span>  
  
## <a name="use-d3dimage-sparingly"></a><span data-ttu-id="dce59-108">D3DImage を慎重に使用する</span><span class="sxs-lookup"><span data-stu-id="dce59-108">Use D3DImage Sparingly</span></span>  
 <span data-ttu-id="dce59-109"><xref:System.Windows.Interop.D3DImage> インスタンスでホストされている Direct3D9 コンテンツは、純粋な Direct3D アプリケーションほど高速にレンダリングされません。</span><span class="sxs-lookup"><span data-stu-id="dce59-109">Direct3D9 content hosted in a <xref:System.Windows.Interop.D3DImage> instance does not render as fast as in a pure Direct3D application.</span></span> <span data-ttu-id="dce59-110">サーフェイスをコピーしてコマンド バッファーをフラッシュすると、コストのかかる操作になる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="dce59-110">Copying the surface and flushing the command buffer can be costly operations.</span></span> <span data-ttu-id="dce59-111"><xref:System.Windows.Interop.D3DImage> インスタンスの数が増えるにつれて、より多くのフラッシュが発生し、パフォーマンスが低下します。</span><span class="sxs-lookup"><span data-stu-id="dce59-111">As the number of <xref:System.Windows.Interop.D3DImage> instances increases, more flushing occurs, and performance degrades.</span></span> <span data-ttu-id="dce59-112">そのため、<xref:System.Windows.Interop.D3DImage> は慎重に使用してください。</span><span class="sxs-lookup"><span data-stu-id="dce59-112">Therefore, you should use <xref:System.Windows.Interop.D3DImage> sparingly.</span></span>  
  
## <a name="best-practices-on-windows-vista"></a><span data-ttu-id="dce59-113">Windows Vista のベスト プラクティス</span><span class="sxs-lookup"><span data-stu-id="dce59-113">Best Practices on Windows Vista</span></span>  
 <span data-ttu-id="dce59-114">Windows ディスプレイ ドライバー モデル (WDDM) を使用するように構成されたディスプレイを使う Windows Vista で最高のパフォーマンスを得るには、`IDirect3DDevice9Ex` デバイスに Direct3D9 サーフェイスを作成します。</span><span class="sxs-lookup"><span data-stu-id="dce59-114">For best performance on Windows Vista with a display that is configured to use the Windows Display Driver Model (WDDM), create your Direct3D9 surface on an `IDirect3DDevice9Ex` device.</span></span> <span data-ttu-id="dce59-115">これにより、サーフェイスの共有が可能になります。</span><span class="sxs-lookup"><span data-stu-id="dce59-115">This enables surface sharing.</span></span> <span data-ttu-id="dce59-116">ビデオ カードは、Windows Vista の `D3DDEVCAPS2_CAN_STRETCHRECT_FROM_TEXTURES` および `D3DCAPS2_CANSHARERESOURCE` ドライバー機能をサポートしている必要があります。</span><span class="sxs-lookup"><span data-stu-id="dce59-116">The video card must support the `D3DDEVCAPS2_CAN_STRETCHRECT_FROM_TEXTURES` and `D3DCAPS2_CANSHARERESOURCE` driver capabilities on Windows Vista.</span></span> <span data-ttu-id="dce59-117">その他の設定では、ソフトウェアを介してサーフェイスがコピーされるため、パフォーマンスが大幅に低下します。</span><span class="sxs-lookup"><span data-stu-id="dce59-117">Any other settings cause the surface to be copied through software, which reduces performance significantly.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="dce59-118">Windows XP Display Driver Model (XDDM) を使用するように Windows Vista のディスプレイが構成されている場合、設定に関係なく、サーフェイスは常にソフトウェアを介してコピーされます。</span><span class="sxs-lookup"><span data-stu-id="dce59-118">If Windows Vista has a display that is configured to use the Windows XP Display Driver Model (XDDM), the surface is always copied through software, regardless of settings.</span></span> <span data-ttu-id="dce59-119">適切な設定とビデオ カードを使用して WDDM を使用すると、Windows Vista でのパフォーマンスが向上します。これは、サーフェイスのコピーがハードウェアで実行されるためです。</span><span class="sxs-lookup"><span data-stu-id="dce59-119">With the proper settings and video card, you will see better performance on Windows Vista when you use the WDDM because surface copies are performed in hardware.</span></span>  
  
## <a name="best-practices-on-windows-xp"></a><span data-ttu-id="dce59-120">Windows XP のベスト プラクティス</span><span class="sxs-lookup"><span data-stu-id="dce59-120">Best Practices on Windows XP</span></span>  
 <span data-ttu-id="dce59-121">Windows XP Display Driver Model (XDDM) を使用する Windows XP で最適なパフォーマンスを得るには、`IDirect3DSurface9::GetDC` メソッドが呼び出されたときに正しく動作するロック可能なサーフェイスを作成します。</span><span class="sxs-lookup"><span data-stu-id="dce59-121">For best performance on Windows XP, which uses the Windows XP Display Driver Model (XDDM), create a lockable surface that behaves correctly when the `IDirect3DSurface9::GetDC` method is called.</span></span> <span data-ttu-id="dce59-122">内部的には、`BitBlt` メソッドによってハードウェア内のデバイス間でサーフェイスが転送されます。</span><span class="sxs-lookup"><span data-stu-id="dce59-122">Internally, the `BitBlt` method transfers the surface across devices in hardware.</span></span> <span data-ttu-id="dce59-123">`GetDC` メソッドは常に XRGB サーフェイス上で機能します。</span><span class="sxs-lookup"><span data-stu-id="dce59-123">The `GetDC` method always works on XRGB surfaces.</span></span> <span data-ttu-id="dce59-124">ただし、クライアント コンピューターで Windows XP SP3 または SP2 が実行されていて、クライアントにもレイヤードウィンドウ機能の修正プログラムがインストールされている場合、このメソッドは ARGB サーフェイス上でのみ機能します。</span><span class="sxs-lookup"><span data-stu-id="dce59-124">However, if the client computer is running Windows XP with SP3 or SP2, and if the client also has the hotfix for the layered-window feature, this method only works on ARGB surfaces.</span></span> <span data-ttu-id="dce59-125">ビデオ カードは、`D3DDEVCAPS2_CAN_STRETCHRECT_FROM_TEXTURES` ドライバー機能をサポートしている必要があります。</span><span class="sxs-lookup"><span data-stu-id="dce59-125">The video card must support the `D3DDEVCAPS2_CAN_STRETCHRECT_FROM_TEXTURES` driver capability.</span></span>  
  
 <span data-ttu-id="dce59-126">デスクトップの表示深度が 16 ビットの場合、パフォーマンスが大幅に低下する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="dce59-126">A 16-bit desktop display depth can significantly reduce performance.</span></span> <span data-ttu-id="dce59-127">32 ビットのデスクトップをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="dce59-127">A 32-bit desktop is recommended.</span></span>  
  
 <span data-ttu-id="dce59-128">Windows Vista および Windows XP 用に開発している場合は、Windows XP 上でパフォーマンスをテストします。</span><span class="sxs-lookup"><span data-stu-id="dce59-128">If you are developing for Windows Vista and Windows XP, test the performance on Windows XP.</span></span> <span data-ttu-id="dce59-129">Windows XP 上ではビデオ メモリが不足することが問題です。</span><span class="sxs-lookup"><span data-stu-id="dce59-129">Running out of video memory on Windows XP is a concern.</span></span> <span data-ttu-id="dce59-130">さらに、Windows XP 上の <xref:System.Windows.Interop.D3DImage> には、追加のビデオ メモリ コピーが必要なため、Windows Vista WDDM よりも多くのビデオ メモリと帯域幅が使用されます。</span><span class="sxs-lookup"><span data-stu-id="dce59-130">In addition, <xref:System.Windows.Interop.D3DImage> on Windows XP uses more video memory and bandwidth than Windows Vista WDDM, due to a necessary extra video memory copy.</span></span> <span data-ttu-id="dce59-131">そのため、同じビデオ ハードウェアの場合、Windows XP のパフォーマンスは Windows Vista のパフォーマンスよりも低くなることが予想されます。</span><span class="sxs-lookup"><span data-stu-id="dce59-131">Therefore, you can expect performance to be worse on Windows XP than on Windows Vista for the same video hardware.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="dce59-132">XDDM は、Windows XP と Windows Vista の両方で使用できます。ただし、WDDM は Windows Vista でのみ使用できます。</span><span class="sxs-lookup"><span data-stu-id="dce59-132">XDDM is available on both Windows XP and Windows Vista; however, WDDM is available only on Windows Vista.</span></span>  
  
## <a name="general-best-practices"></a><span data-ttu-id="dce59-133">一般的なベスト プラクティス</span><span class="sxs-lookup"><span data-stu-id="dce59-133">General Best Practices</span></span>  
 <span data-ttu-id="dce59-134">デバイスを作成するときは、`D3DCREATE_MULTITHREADED` 作成フラグを使用します。</span><span class="sxs-lookup"><span data-stu-id="dce59-134">When you create the device, use the `D3DCREATE_MULTITHREADED` creation flag.</span></span> <span data-ttu-id="dce59-135">これにより、パフォーマンスは低下しますが、WPF レンダリング システムでは、このデバイス上のメソッドを別のスレッドから呼び出します。</span><span class="sxs-lookup"><span data-stu-id="dce59-135">This reduces performance, but the WPF rendering system calls methods on this device from another thread.</span></span> <span data-ttu-id="dce59-136">2 つのスレッドが同時にデバイスにアクセスしないように、ロック プロトコルに正しく従ってください。</span><span class="sxs-lookup"><span data-stu-id="dce59-136">Be sure to follow the locking protocol correctly, so that no two threads access the device at the same time.</span></span>  
  
 <span data-ttu-id="dce59-137">レンダリングが WPF マネージ スレッドで実行される場合は、`D3DCREATE_FPU_PRESERVE` 作成フラグを使用してデバイスを作成することを強くお勧めします。</span><span class="sxs-lookup"><span data-stu-id="dce59-137">If your rendering is performed on a WPF managed thread, it is strongly recommended that you create the device with the `D3DCREATE_FPU_PRESERVE` creation flag.</span></span> <span data-ttu-id="dce59-138">この設定がない場合、D3D レンダリングによって WPF 倍精度演算の精度が低下し、レンダリングの問題が発生する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="dce59-138">Without this setting, the D3D rendering can reduce the accuracy of WPF double-precision operations and introduce rendering issues.</span></span>  
  
 <span data-ttu-id="dce59-139">ハードウェア サポートなしで非 pow2 サーフェイスをタイル表示する場合、または <xref:System.Windows.Interop.D3DImage> を含む <xref:System.Windows.Media.DrawingBrush> または <xref:System.Windows.Media.VisualBrush> をタイル表示する場合を除き、<xref:System.Windows.Interop.D3DImage> のタイル表示は高速です。</span><span class="sxs-lookup"><span data-stu-id="dce59-139">Tiling a <xref:System.Windows.Interop.D3DImage> is fast, unless you tile a non-pow2 surface without hardware support, or if you tile a <xref:System.Windows.Media.DrawingBrush> or <xref:System.Windows.Media.VisualBrush> that contains a <xref:System.Windows.Interop.D3DImage>.</span></span>  
  
## <a name="best-practices-for-multi-monitor-displays"></a><span data-ttu-id="dce59-140">マルチモニター ディスプレイのベスト プラクティス</span><span class="sxs-lookup"><span data-stu-id="dce59-140">Best Practices for Multi-Monitor Displays</span></span>  
 <span data-ttu-id="dce59-141">複数のモニターを備えたコンピューターを使用している場合は、前述のベスト プラクティスに従う必要があります。</span><span class="sxs-lookup"><span data-stu-id="dce59-141">If you are using a computer that has multiple monitors, you should follow the previously described best practices.</span></span> <span data-ttu-id="dce59-142">マルチ モニター構成の場合、パフォーマンスに関するその他の考慮事項もあります。</span><span class="sxs-lookup"><span data-stu-id="dce59-142">There are also some additional performance considerations for a multi-monitor configuration.</span></span>  
  
 <span data-ttu-id="dce59-143">バック バッファーを作成すると、特定のデバイスとアダプターに作成されますが、WPF によって任意のアダプターにフロント バッファーが表示される場合があります。</span><span class="sxs-lookup"><span data-stu-id="dce59-143">When you create the back buffer, it is created on a specific device and adapter, but WPF may display the front buffer on any adapter.</span></span> <span data-ttu-id="dce59-144">アダプター間でコピーしてフロント バッファーを更新すると、非常にコストが高くなる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="dce59-144">Copying across adapters to update the front buffer can be very expensive.</span></span> <span data-ttu-id="dce59-145">複数のビデオ カードと `IDirect3DDevice9Ex` デバイスで WDDM を使用するように構成されている Windows Vista で、フロント バッファーが別のアダプター上にあり、ビデオ カードは同じである場合、パフォーマンスは低下しません。</span><span class="sxs-lookup"><span data-stu-id="dce59-145">On Windows Vista that is configured to use the WDDM with multiple video cards and with an `IDirect3DDevice9Ex` device, if the front buffer is on a different adapter but still the same video card, there is no performance penalty.</span></span> <span data-ttu-id="dce59-146">ただし、複数のビデオ カードを使用する Windows XP と XDDM で、フロント バッファーがバック バッファーとは異なるアダプターに表示される場合は、パフォーマンスが大幅に低下します。</span><span class="sxs-lookup"><span data-stu-id="dce59-146">However, on Windows XP and the XDDM with multiple video cards, there is a significant performance penalty when the front buffer is displayed on a different adapter than the back buffer.</span></span> <span data-ttu-id="dce59-147">詳細については、「[WPF と Direct3D9 の相互運用性](wpf-and-direct3d9-interoperation.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="dce59-147">For more information, see [WPF and Direct3D9 Interoperation](wpf-and-direct3d9-interoperation.md).</span></span>  
  
## <a name="performance-summary"></a><span data-ttu-id="dce59-148">パフォーマンスの概要</span><span class="sxs-lookup"><span data-stu-id="dce59-148">Performance Summary</span></span>  
 <span data-ttu-id="dce59-149">次の表は、オペレーティング システムの機能、ピクセル形式、およびサーフェイスのロックの可否としてのフロント バッファー更新プログラムのパフォーマンスを示しています。</span><span class="sxs-lookup"><span data-stu-id="dce59-149">The following table shows performance of the front buffer update as a function of operating system, pixel format, and surface lockability.</span></span> <span data-ttu-id="dce59-150">フロント バッファーとバック バッファーは同じアダプター上にあると見なされます。</span><span class="sxs-lookup"><span data-stu-id="dce59-150">The front buffer and back buffer are assumed to be on the same adapter.</span></span> <span data-ttu-id="dce59-151">アダプターの構成にもよりますが、通常、ハードウェア更新プログラムはソフトウェア更新プログラムよりもはるかに高速です。</span><span class="sxs-lookup"><span data-stu-id="dce59-151">Depending on the adapter configuration, hardware updates are generally much faster than software updates.</span></span>  
  
|<span data-ttu-id="dce59-152">サーフェイスのピクセル形式</span><span class="sxs-lookup"><span data-stu-id="dce59-152">Surface pixel format</span></span>|<span data-ttu-id="dce59-153">Windows Vista、WDDM、および 9Ex</span><span class="sxs-lookup"><span data-stu-id="dce59-153">Windows Vista, WDDM and 9Ex</span></span>|<span data-ttu-id="dce59-154">その他の Windows Vista の構成</span><span class="sxs-lookup"><span data-stu-id="dce59-154">Other Windows Vista configurations</span></span>|<span data-ttu-id="dce59-155">Windows XP SP3 または SP2 および修正プログラム</span><span class="sxs-lookup"><span data-stu-id="dce59-155">Windows XP SP3 or SP2 w/ hotfix</span></span>|<span data-ttu-id="dce59-156">Windows XP SP2</span><span class="sxs-lookup"><span data-stu-id="dce59-156">Windows XP SP2</span></span>|  
|--------------------------|---------------------------------|----------------------------------------|--------------------------------------|--------------------|  
|<span data-ttu-id="dce59-157">D3DFMT_X8R8G8B8 (ロック不可能)</span><span class="sxs-lookup"><span data-stu-id="dce59-157">D3DFMT_X8R8G8B8 (not lockable)</span></span>|<span data-ttu-id="dce59-158">**ハードウェア更新プログラム**</span><span class="sxs-lookup"><span data-stu-id="dce59-158">**Hardware Update**</span></span>|<span data-ttu-id="dce59-159">ソフトウェア更新プログラム</span><span class="sxs-lookup"><span data-stu-id="dce59-159">Software Update</span></span>|<span data-ttu-id="dce59-160">ソフトウェア更新プログラム</span><span class="sxs-lookup"><span data-stu-id="dce59-160">Software Update</span></span>|<span data-ttu-id="dce59-161">ソフトウェア更新プログラム</span><span class="sxs-lookup"><span data-stu-id="dce59-161">Software Update</span></span>|  
|<span data-ttu-id="dce59-162">D3DFMT_X8R8G8B8 (ロック可能)</span><span class="sxs-lookup"><span data-stu-id="dce59-162">D3DFMT_X8R8G8B8 (lockable)</span></span>|<span data-ttu-id="dce59-163">**ハードウェア更新プログラム**</span><span class="sxs-lookup"><span data-stu-id="dce59-163">**Hardware Update**</span></span>|<span data-ttu-id="dce59-164">ソフトウェア更新プログラム</span><span class="sxs-lookup"><span data-stu-id="dce59-164">Software Update</span></span>|<span data-ttu-id="dce59-165">**ハードウェア更新プログラム**</span><span class="sxs-lookup"><span data-stu-id="dce59-165">**Hardware Update**</span></span>|<span data-ttu-id="dce59-166">**ハードウェア更新プログラム**</span><span class="sxs-lookup"><span data-stu-id="dce59-166">**Hardware Update**</span></span>|  
|<span data-ttu-id="dce59-167">D3DFMT_A8R8G8B8 (ロック不可能)</span><span class="sxs-lookup"><span data-stu-id="dce59-167">D3DFMT_A8R8G8B8 (not lockable)</span></span>|<span data-ttu-id="dce59-168">**ハードウェア更新プログラム**</span><span class="sxs-lookup"><span data-stu-id="dce59-168">**Hardware Update**</span></span>|<span data-ttu-id="dce59-169">ソフトウェア更新プログラム</span><span class="sxs-lookup"><span data-stu-id="dce59-169">Software Update</span></span>|<span data-ttu-id="dce59-170">ソフトウェア更新プログラム</span><span class="sxs-lookup"><span data-stu-id="dce59-170">Software Update</span></span>|<span data-ttu-id="dce59-171">ソフトウェア更新プログラム</span><span class="sxs-lookup"><span data-stu-id="dce59-171">Software Update</span></span>|  
|<span data-ttu-id="dce59-172">D3DFMT_A8R8G8B8 (ロック可能)</span><span class="sxs-lookup"><span data-stu-id="dce59-172">D3DFMT_A8R8G8B8 (lockable)</span></span>|<span data-ttu-id="dce59-173">**ハードウェア更新プログラム**</span><span class="sxs-lookup"><span data-stu-id="dce59-173">**Hardware Update**</span></span>|<span data-ttu-id="dce59-174">ソフトウェア更新プログラム</span><span class="sxs-lookup"><span data-stu-id="dce59-174">Software Update</span></span>|<span data-ttu-id="dce59-175">**ハードウェア更新プログラム**</span><span class="sxs-lookup"><span data-stu-id="dce59-175">**Hardware Update**</span></span>|<span data-ttu-id="dce59-176">ソフトウェア更新プログラム</span><span class="sxs-lookup"><span data-stu-id="dce59-176">Software Update</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="dce59-177">関連項目</span><span class="sxs-lookup"><span data-stu-id="dce59-177">See also</span></span>

- <xref:System.Windows.Interop.D3DImage>
- [<span data-ttu-id="dce59-178">WPF と Direct3D9 の相互運用性</span><span class="sxs-lookup"><span data-stu-id="dce59-178">WPF and Direct3D9 Interoperation</span></span>](wpf-and-direct3d9-interoperation.md)
- [<span data-ttu-id="dce59-179">チュートリアル: WPF でホストするための Direct3D9 コンテンツの作成</span><span class="sxs-lookup"><span data-stu-id="dce59-179">Walkthrough: Creating Direct3D9 Content for Hosting in WPF</span></span>](walkthrough-creating-direct3d9-content-for-hosting-in-wpf.md)
- [<span data-ttu-id="dce59-180">チュートリアル: WPF での Direct3D9 コンテンツのホスト</span><span class="sxs-lookup"><span data-stu-id="dce59-180">Walkthrough: Hosting Direct3D9 Content in WPF</span></span>](walkthrough-hosting-direct3d9-content-in-wpf.md)
